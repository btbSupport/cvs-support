[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Order Processing Request",
  "enabled": 1,
  "modified": "2025-03-12 22:25:31.942233",
  "module": "Btb Cvs Support",
  "name": "opr_controller",
  "script": "frappe.ui.form.on('Order Processing Request', {\n\n    sales_order(frm, cdt, cdn) {\n        console.log(frm.doc.sales_order);\n        assignQuantities(frm, cdn);\n    }\n\n});\n\nfrappe.ui.form.on('Quantities Table', {\n    straight_sqm: (frm, cdt, cdn) => {\n        updateFittingSqm(frm, cdt, cdn);\n    },\n    total_nos: (frm, cdt, cdn) => {\n        updateFittingSqm(frm, cdt, cdn);\n    },\n    straight_no: (frm, cdt, cdn) => {\n        updateFittingNos(frm, cdt, cdn);\n    },\n    total_duct_pcs: (frm, cdt, cdn) => {\n        updateFittingNos(frm, cdt, cdn);\n    }\n});\n\nfunction updateFittingSqm(frm, cdt, cdn) {\n    let item = locals[cdt][cdn];\n    if (item.uom.toLowerCase() != \"sqm\") return;\n    frappe.model.set_value(cdt, cdn, \"fitting_sqm\", item.quantity - item.straight_sqm);\n    frm.refresh_field(\"quantities_required\");\n}\n\nfunction updateFittingNos(frm, cdt, cdn) {\n    let item = locals[cdt][cdn];\n    if (item.uom.toLowerCase() != \"sqm\") return;\n    if(isNaN(item.total_nos) || isNaN(item.straight_no)) return;\n    frappe.model.set_value(cdt, cdn, \"fitting_no\", item.total_nos - item.straight_no);\n    frm.refresh_field(\"quantities_required\");\n}\n\nfunction assignQuantities(frm, cdn) {\n    frappe.call({\n        type: \"GET\",\n        method: \"btb_cvs_support.api.opr.get_pending_quantities\",\n        args: {\n            \"sales_order_number\": frm.doc.sales_order,\n            \"opr_name\": cdn\n        },\n        callback: function (result) {\n            let items = result.message;\n            for (var i = 0; i < items.length; i++) {\n                if (items[i].custom_manufactured_item) addQuantity(frm, items[i]);\n                else addAccessory(frm, items[i]);\n            }\n            frm.refresh_field(\"quantities_required\");\n            frm.refresh_field(\"accessories\");\n        }\n    })\n}\n\nfunction addQuantity(frm, item) {\n    let child = getItem(frm.doc.quantities_required, \"so_detail\", item.so_detail);\n    if (child !== null) return;\n    child = {\n        so_detail: item.so_detail, item_code: item.item_code, description: item.description, \n        quantity: item.quantity, rate: item.rate, amount: item.rate * item.quantity,\n        so: frm.doc.sales_order, uom: item.uom\n    };\n    frm.add_child(\"quantities_required\", child);\n\n}\n\nfunction addAccessory(frm, item) {\n    let child = getItem(frm.doc.accessories, \"item\", item.item_code);\n    if (child !== null) return;\n    child = {\n        so_detail: item.so_detail, item: item.item_code, description: item.description, \n        quantity: item.quantity, rate: item.rate, amount: item.rate * item.quantity, \n        uom: item.uom\n    };\n    frm.add_child(\"accessories\", child);\n\n}\n\nfunction getItem(items, property, value) {\n    let result = items.filter(item => item[property] === value);\n    if (result.length === 0) return null;\n    return result[0];\n}",
  "view": "Form"
 }
]